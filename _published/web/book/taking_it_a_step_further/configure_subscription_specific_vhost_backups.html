<!DOCTYPE HTML>
<html lang="en-US" manifest="../manifest.appcache">
    
    <head>
        
        <meta charset="UTF-8">
        <title>Configure Subscription Specific (Vhost) Backups | Media Temple Amazon S3 Backup for DV (this works on other Linux servers too)</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 0.5.2">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    <link rel="next" href="../getting_help/README.html" />
    
    
    <link rel="prev" href="../taking_it_a_step_further/article.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book"  data-level="6.2" data-basepath=".." data-revision="1406597186540">
    <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    
    <a href="https://github.com/null" target="_blank" class="btn pull-left home-bookmark" aria-label="GitHub home"><i class="fa fa-bookmark-o"></i></a>
    
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    <span id="font-settings-wrapper">
        <a href="#" class="btn pull-left toggle-font-settings" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="btn-group btn-block">
        <button id="reduce-font-size" class="btn btn-default">A</button>
        <button id="enlarge-font-size" class="btn btn-default">A</button>
    </div>

    <ul class="list-group font-family-list">
        <li class="list-group-item" data-font="0">Serif</li>
        <li class="list-group-item" data-font="1">Sans</li>
    </ul>

    <div class="btn-group btn-group-xs btn-block color-theme-list">
        <button type="button" class="btn btn-default" id="color-theme-preview-0" data-theme="0">White</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-1" data-theme="1">Sepia</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-2" data-theme="2">Night</button>
    </div>
</div>

    </span>

    <!-- Actions Right -->
    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    

    

    <!-- Title -->
    <h1>
        <i class="fa fa-spinner fa-spin"></i>
        <a href="../" >Media Temple Amazon S3 Backup for DV (this works on other Linux servers too)</a>
    </h1>
</div>

    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Search" class="form-control" />
    </div>
    <ul class="summary">
        
        

        

        

        

        <li data-level="0" data-path="index.html">
            <a href="../"><i class="fa fa-check"></i> Introduction</a>
        </li>
        
    
        <li class="chapter " data-level="1" data-path="prepare_the_server/README.html">
            
            <a href="../prepare_the_server/README.html">
                <i class="fa fa-check"></i> <b>1.</b> Prepare The Server
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="configure_amazon_access/README.html">
            
            <a href="../configure_amazon_access/README.html">
                <i class="fa fa-check"></i> <b>2.</b> Configure Amazon Access
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="configure_plesk_for_full_backup/README.html">
            
            <a href="../configure_plesk_for_full_backup/README.html">
                <i class="fa fa-check"></i> <b>3.</b> Configure Plesk for Full Backup
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="automating_the_process/README.html">
            
            <a href="../automating_the_process/README.html">
                <i class="fa fa-check"></i> <b>4.</b> Automating the Process
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="restoring_from_a_backup/README.html">
            
            <a href="../restoring_from_a_backup/README.html">
                <i class="fa fa-check"></i> <b>5.</b> Restoring From A Backup
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="taking_it_a_step_further/README.html">
            
            <a href="../taking_it_a_step_further/README.html">
                <i class="fa fa-check"></i> <b>6.</b> Taking It A Step Further
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.1" data-path="taking_it_a_step_further/article.html">
            
            <a href="../taking_it_a_step_further/article.html">
                <i class="fa fa-check"></i> <b>6.1.</b> Configure Retention Policies
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="taking_it_a_step_further/configure_subscription_specific_vhost_backups.html">
            
            <a href="../taking_it_a_step_further/configure_subscription_specific_vhost_backups.html">
                <i class="fa fa-check"></i> <b>6.2.</b> Configure Subscription Specific (Vhost) Backups
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="7" data-path="getting_help/README.html">
            
            <a href="../getting_help/README.html">
                <i class="fa fa-check"></i> <b>7.</b> Getting Help
            </a>
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Generated using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="page-wrapper" tabindex="-1">
                <div class="book-progress">
    <div class="bar">
        <div class="inner" style="width: 88.88888888888889%;min-width: 77.77777777777777%;"></div>
    </div>
    <div class="chapters">
    
        <a href="../index.html" title="Introduction" class="chapter done new-chapter" data-progress="0" style="left: 0%;"></a>
    
        <a href="../prepare_the_server/README.html" title="Prepare The Server" class="chapter done new-chapter" data-progress="1" style="left: 11.11111111111111%;"></a>
    
        <a href="../configure_amazon_access/README.html" title="Configure Amazon Access" class="chapter done new-chapter" data-progress="2" style="left: 22.22222222222222%;"></a>
    
        <a href="../configure_plesk_for_full_backup/README.html" title="Configure Plesk for Full Backup" class="chapter done new-chapter" data-progress="3" style="left: 33.333333333333336%;"></a>
    
        <a href="../automating_the_process/README.html" title="Automating the Process" class="chapter done new-chapter" data-progress="4" style="left: 44.44444444444444%;"></a>
    
        <a href="../restoring_from_a_backup/README.html" title="Restoring From A Backup" class="chapter done new-chapter" data-progress="5" style="left: 55.55555555555556%;"></a>
    
        <a href="../taking_it_a_step_further/README.html" title="Taking It A Step Further" class="chapter done new-chapter" data-progress="6" style="left: 66.66666666666667%;"></a>
    
        <a href="../taking_it_a_step_further/article.html" title="Configure Retention Policies" class="chapter done " data-progress="6.1" style="left: 77.77777777777777%;"></a>
    
        <a href="../taking_it_a_step_further/configure_subscription_specific_vhost_backups.html" title="Configure Subscription Specific (Vhost) Backups" class="chapter done " data-progress="6.2" style="left: 88.88888888888889%;"></a>
    
        <a href="../getting_help/README.html" title="Getting Help" class="chapter  new-chapter" data-progress="7" style="left: 100%;"></a>
    
    </div>
</div>

                <div class="page-inner">
                
                    <section class="normal" id="section-gitbook_22">
                    
                        <h1 id="configure-subscription-specific-vhost-backups">Configure Subscription Specific (Vhost) Backups</h1>
<p>You can also store single site backups in a separate bucket. Why would we want to do that? A separate bucket makes sense because we can run different backup frequencies and also apply different retention policies. Here is how it would work:</p>
<p><img src="../assets/22-AnimatedSiteBackup.gif" alt="22-AnimatedSiteBackup.gif"></p>
<p>To configure the backups, we would have to create another folder for our site backups:</p>
<pre><code>mkdir -p /var/www/vhosts/backup.mysite.com/s3backups/sites/
</code></pre><p>Be sure to set the right permissions after that:</p>
<pre><code>chown -R backupuser:psacln /var/www/vhosts/backup.mysite.com/s3backups/sites/
</code></pre><p>Now you can go into the backup.mysite.com subscription and create specific FTP users for your sites. Once you have those users created, you can then go into the subscription that you want to backup and configure the Backup Manager (just like how we did it for our Full Server backup). We will also have to modify our script in the cron.hourly:</p>
<pre><code>nano /etc/cron.hourly/aws-s3move
</code></pre><p>Then update the script to this. Be sure to configure the options at the top! (<a href="https://gist.github.com/jaydrogers/9957551#file-amazons3move-sitesandfull-sh" target="_blank">Online Version available here</a>)</p>
<pre><code>#! /bin/bash
# Author: Jay Rogers - jay@521dimensions.com

#IMPORTANT -- CONFIGURATION VARIABLES
BACKUPDOMAIN=backup.mydomain.com
SITESBUCKETNAME=myserver-plesksites
SERVERBUCKETNAME=myserver-pleskfull

#Check to see if there are any individual SITES to back up. If so, move the backups to Amazon S3
if [ &quot;$(find /var/www/vhosts/$BACKUPDOMAIN/s3backups/sites/ -name &quot;*.tar&quot;)&quot; ]; then
        #Make sure that CRON is able to find the AWS Configuration File
        export AWS_CONFIG_FILE=/root/.aws/config
        #Execute S3 moved to Bucket configured above
        aws s3 mv /var/www/vhosts/$BACKUPDOMAIN/s3backups/sites/ s3://$SITESBUCKETNAME --recursive
fi

#Check to see if there are any SERVER backups to move. If so, move the backups to Amazon S3
if [ &quot;$(find /var/www/vhosts/$BACKUPDOMAIN/s3backups/fullserver/ -name &quot;*.tar&quot;)&quot; ]; then
        #Make sure that CRON is able to find the AWS Configuration File
        export AWS_CONFIG_FILE=/root/.aws/config
        #Execute S3 moved to Bucket configured above
        aws s3 mv /var/www/vhosts/$BACKUPDOMAIN/s3backups/fullserver/ s3://$SERVERBUCKETNAME --recursive
        exit 0
else
        #If nothing exists in any of these folders, then do nothing
        exit 0
fi
</code></pre><p>No matter how many other individual site backups you add, this script does not need to be modified. It grabs recursively from s3backups/sites/ and will upload them to Amazon S3.</p>

                    
                    </section>
                
                </div>
            </div>
        </div>

        
        <a href="../taking_it_a_step_further/article.html" class="navigation navigation-prev " aria-label="Previous page: Configure Retention Policies"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../getting_help/README.html" class="navigation navigation-next " aria-label="Next page: Getting Help"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/jsrepl/jsrepl.js" id="jsrepl-script"></script>
<script src="../gitbook/app.js"></script>

    
    <script src="http://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
